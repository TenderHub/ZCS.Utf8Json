using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Utf8Json.Resolvers;
using Utf8Json.Tests.Data;
using Xunit;

namespace Utf8Json.Tests
{
    public class DeserializeWithStringEscapeTest
    {
        [Theory]
        [InlineData(@"{""Name"":""\\"", ""Test"":""Something""}", "Something")]
        [InlineData(@"{""Name"":"""", ""Test"":""Something""}", "Something")]
        [InlineData(@"{""Name"":""\"""", ""Test"":""Something""}", "Something")]
        [InlineData(@"{""Name"":""\""\"""", ""Test"":""Something""}", "Something")]
        public void ShouldNotEscapeDoublequoteWithEscapedBackslash(string json, string expectedValue)
        {
            // Arrage
            var reader = new JsonReader(Encoding.UTF8.GetBytes(json));

            // Act
            reader.ReadIsBeginObject();
            var count = 0;
            while (!reader.ReadIsEndObjectWithSkipValueSeparator(ref count))
            {
                var name = reader.ReadPropertyName();
                if (name == "Test")
                    reader.ReadString().Is(expectedValue);
                else
                {
                    reader.ReadNextBlock();
                }
            }

            reader.ReadIsValueSeparator();
        }
        
        [InlineData("{\"actions\":null,\"changed\":false,\"class\":\"18.2003.00.00.0.00.00\",\"collections\":[{\"actions\":null,\"component\":null,\"display_name\":null,\"fields\":[{\"input\":\"select\",\"label\":\"MIME-тип файла\",\"mode\":\"R\",\"name\":\"18.0000.01.01.1.01.00\",\"placeholder\":null,\"seq\":1,\"type\":\"S\",\"valid_values\":[{\"display_name\":\"png\",\"enabled_flag\":true,\"name\":\"image/png\"},{\"display_name\":\"gif\",\"enabled_flag\":true,\"name\":\"image/gif\"},{\"display_name\":\"jpeg\",\"enabled_flag\":true,\"name\":\"image/jpeg\"},{\"display_name\":\"pjpeg\",\"enabled_flag\":true,\"name\":\"image/pjpeg\"},{\"display_name\":\"pdf\",\"enabled_flag\":true,\"name\":\"application/pdf\"},{\"display_name\":\"doc\",\"enabled_flag\":true,\"name\":\"application/msword\"},{\"display_name\":\"docx\",\"enabled_flag\":true,\"name\":\"application/vnd.openxmlformats-officedocument.wordprocessingml.document\"},{\"display_name\":\"sig\",\"enabled_flag\":true,\"name\":\"application/pgp-signature\"},{\"display_name\":\"cer\",\"enabled_flag\":true,\"name\":\"application/pkix-cert\"},{\"display_name\":\"cer\",\"enabled_flag\":true,\"name\":\"application/x-x509-ca-cert\"},{\"display_name\":\"xlsx\",\"enabled_flag\":true,\"name\":\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\"},{\"display_name\":\"xls\",\"enabled_flag\":true,\"name\":\"application/vnd.ms-excel\"},{\"display_name\":\"xml\",\"enabled_flag\":true,\"name\":\"text/xml\"},{\"display_name\":\"tiff\",\"enabled_flag\":true,\"name\":\"image/tiff\"},{\"display_name\":\"rar\",\"enabled_flag\":true,\"name\":\"application/vnd.rar\"},{\"display_name\":\"rtf\",\"enabled_flag\":true,\"name\":\"text/rtf; charset=UTF-8\"}]},{\"input\":null,\"label\":\"Оригинальное название файла\",\"mode\":\"R\",\"name\":\"18.0000.01.01.1.02.00\",\"placeholder\":null,\"seq\":2,\"type\":\"S\",\"valid_values\":null},{\"input\":null,\"label\":\"Размер файла в байтах\",\"mode\":\"R\",\"name\":\"18.0000.01.01.1.03.00\",\"placeholder\":null,\"seq\":3,\"type\":\"I\",\"valid_values\":null},{\"input\":\"select\",\"label\":\"Статус проверки файла\",\"mode\":\"R\",\"name\":\"18.0000.01.01.1.04.00\",\"placeholder\":null,\"seq\":4,\"type\":\"S\",\"valid_values\":[{\"display_name\":\"value=Проверка не проводилась;colour=red\",\"enabled_flag\":true,\"name\":\"N\"},{\"display_name\":\"value=Проверка пройдена;colour=blue\",\"enabled_flag\":true,\"name\":\"V\"},{\"display_name\":\"value=Проверка не пройдена;colour=red\",\"enabled_flag\":true,\"name\":\"M\"},{\"display_name\":\"value=Подписан;colour=green\",\"enabled_flag\":true,\"name\":\"S\"}]},{\"input\":null,\"label\":\"Контрольная сумма\",\"mode\":\"R\",\"name\":\"18.0000.01.01.1.05.00\",\"placeholder\":null,\"seq\":5,\"type\":\"S\",\"valid_values\":null},{\"input\":null,\"label\":\"Время загрузки файла\",\"mode\":\"R\",\"name\":\"18.0000.01.01.1.06.00\",\"placeholder\":null,\"seq\":6,\"type\":\"I\",\"valid_values\":null},{\"input\":null,\"label\":\"Путь файла в minio\",\"mode\":\"R\",\"name\":\"18.0000.01.01.1.07.00\",\"placeholder\":null,\"seq\":7,\"type\":\"S\",\"valid_values\":null},{\"input\":null,\"label\":\"Путь отсоединенной подписи файла в minio\",\"mode\":\"R\",\"name\":\"18.0000.01.01.1.08.00\",\"placeholder\":null,\"seq\":8,\"type\":\"S\",\"valid_values\":null},{\"input\":null,\"label\":\"Отсоединенная подпись, ИНН\",\"mode\":\"R\",\"name\":\"18.0000.01.01.1.09.00\",\"placeholder\":null,\"seq\":9,\"type\":\"S\",\"valid_values\":null},{\"input\":null,\"label\":\"Путь присоединенной подписи файла в minio\",\"mode\":\"R\",\"name\":\"18.0000.01.01.1.10.00\",\"placeholder\":null,\"seq\":10,\"type\":\"S\",\"valid_values\":null},{\"input\":null,\"label\":\"Присоединенная подпись, ИНН\",\"mode\":\"R\",\"name\":\"18.0000.01.01.1.11.00\",\"placeholder\":null,\"seq\":11,\"type\":\"S\",\"valid_values\":null},{\"input\":null,\"label\":\"Отпечаток сертификата\",\"mode\":\"R\",\"name\":\"18.0000.01.01.1.12.00\",\"placeholder\":null,\"seq\":12,\"type\":\"S\",\"valid_values\":null}],\"id\":40565452,\"name\":\"18.0000.01.00.0.00.00\",\"values\":[{\"fields\":[{\"name\":\"18.0000.01.01.1.01.00\",\"value\":\"application/pdf\"},{\"name\":\"18.0000.01.01.1.02.00\",\"value\":\"Паспорт Литвинова Д.А..pdf\"},{\"name\":\"18.0000.01.01.1.03.00\",\"value\":\"5614383\"},{\"name\":\"18.0000.01.01.1.04.00\",\"value\":\"V\"},{\"name\":\"18.0000.01.01.1.05.00\",\"value\":\"ef7e114888db064763e9097bd2c321ad5e89bf63deaea4d4bae3925b7d18b8ba\"},{\"name\":\"18.0000.01.01.1.06.00\",\"value\":\"1676630149587\"},{\"name\":\"18.0000.01.01.1.07.00\",\"value\":\"content-management-8:1/1113/40300007/40565450/40566784_a0d164c4.pdf\"},{\"name\":\"18.0000.01.01.1.08.00\",\"value\":null},{\"name\":\"18.0000.01.01.1.09.00\",\"value\":null},{\"name\":\"18.0000.01.01.1.10.00\",\"value\":null},{\"name\":\"18.0000.01.01.1.11.00\",\"value\":null},{\"name\":\"18.0000.01.01.1.12.00\",\"value\":null}],\"id\":40566784,\"response_code\":\"A\",\"response_mode\":\"W\",\"response_note\":null,\"version_id\":3}]}],\"component\":null,\"display_name\":\"Паспорт\",\"domain\":\"18.0000.00.00.0.00.00\",\"fields\":[{\"input\":\"date\",\"label\":\"value=Дата создания\",\"mode\":\"R\",\"name\":\"18.0000.00.00.1.01.00\",\"placeholder\":null,\"seq\":1,\"type\":\"I\",\"valid_values\":null,\"value\":\"1676629188912\"},{\"input\":\"input\",\"label\":\"value=Владелец\",\"mode\":\"R\",\"name\":\"18.0000.00.00.1.02.00\",\"placeholder\":null,\"seq\":2,\"type\":\"I\",\"valid_values\":null,\"value\":\"40300007\"},{\"input\":\"date\",\"label\":\"value=Действителен по\",\"mode\":\"R\",\"name\":\"18.0000.00.00.1.03.00\",\"placeholder\":null,\"seq\":3,\"type\":\"I\",\"valid_values\":null,\"value\":null},{\"input\":\"input\",\"label\":\"value=Заголовок\",\"mode\":\"R\",\"name\":\"18.0000.00.00.1.04.00\",\"placeholder\":null,\"seq\":4,\"type\":\"I\",\"valid_values\":null,\"value\":null},{\"input\":\"input\",\"label\":\"value=Хэш документа\",\"mode\":\"R\",\"name\":\"18.0000.00.00.1.05.00\",\"placeholder\":null,\"seq\":5,\"type\":\"S\",\"valid_values\":null,\"value\":\"322f345e39b2455b2ee6424c4a3e5269\"}],\"id\":40565450,\"lifecycle\":[{\"display_name\":\"value=Не загружен;colour=red\",\"enabled_flag\":true,\"name\":\"N\"},{\"display_name\":\"value=Загружен;colour=green\",\"enabled_flag\":true,\"name\":\"U\"},{\"display_name\":\"value=Подписан;colour=blue\",\"enabled_flag\":true,\"name\":\"S\"},{\"display_name\":\"value=Неактуален;colour=grey\",\"enabled_flag\":true,\"name\":\"I\"}],\"owners\":null,\"pages\":[{\"class\":\"18.0000.00.01.0.00.00\",\"component\":null,\"description\":null,\"display_name\":\"value=\",\"fields\":[{\"input\":null,\"label\":\"ИНН для подписания\",\"mode\":\"R\",\"name\":\"18.0000.00.01.1.01.00\",\"placeholder\":null,\"seq\":1,\"type\":\"S\",\"valid_values\":null,\"value\":\"7736652590\"},{\"input\":null,\"label\":\"Подписано\",\"mode\":\"R\",\"name\":\"18.0000.00.01.1.02.00\",\"placeholder\":null,\"seq\":2,\"type\":\"S\",\"valid_values\":null,\"value\":\"false\"}],\"id\":40565453,\"item\":40565450,\"response_code\":null,\"response_mode\":\"W\",\"response_note\":null,\"tags\":null,\"version_id\":2},{\"class\":\"18.0000.00.02.0.00.00\",\"component\":null,\"description\":null,\"display_name\":\"value=\",\"fields\":[{\"input\":\"input\",\"label\":null,\"mode\":\"R\",\"name\":\"18.0000.00.02.1.01.00\",\"placeholder\":null,\"seq\":1,\"type\":\"S\",\"valid_values\":null,\"value\":null}],\"id\":40565455,\"item\":40565450,\"response_code\":null,\"response_mode\":\"W\",\"response_note\":null,\"tags\":null,\"version_id\":1},{\"class\":\"18.0000.00.05.0.00.00\",\"component\":null,\"description\":null,\"display_name\":\"value=Файлы\",\"fields\":[{\"input\":\"file[multi=false;autosubmittable=true;action=A.18.0000.00.00.0.00.00.001]\",\"label\":\"value=Файл;display=L,F\",\"mode\":\"R\",\"name\":\"18.0000.00.05.1.01.00\",\"placeholder\":null,\"seq\":1,\"type\":\"S\",\"valid_values\":null,\"value\":null}],\"id\":40565457,\"item\":40565450,\"response_code\":null,\"response_mode\":\"W\",\"response_note\":null,\"tags\":null,\"version_id\":1},{\"class\":\"18.2003.00.01.0.00.00\",\"component\":null,\"description\":null,\"display_name\":\"value=Личные паспортные данные\",\"fields\":[{\"input\":\"input[required=true;size=64]\",\"label\":\"value=Фамилия;display=L,F\",\"mode\":\"R\",\"name\":\"18.2003.00.01.1.05.00\",\"placeholder\":null,\"seq\":5,\"type\":\"S\",\"valid_values\":null,\"value\":\"Литвинова\"},{\"input\":\"input[required=true;size=64]\",\"label\":\"value=Имя;display=L,F\",\"mode\":\"R\",\"name\":\"18.2003.00.01.1.06.00\",\"placeholder\":null,\"seq\":6,\"type\":\"S\",\"valid_values\":null,\"value\":\"Дарья\"},{\"input\":\"input[size=64]\",\"label\":\"value=Отчество;display=L,F\",\"mode\":\"R\",\"name\":\"18.2003.00.01.1.07.00\",\"placeholder\":null,\"seq\":7,\"type\":\"S\",\"valid_values\":null,\"value\":\"Александровна\"},{\"input\":\"hint[name=S.00.0000.00.00.0.00.00.004;required=true]\",\"label\":\"value=Гражданство;display=L,F\",\"mode\":\"R\",\"name\":\"18.2003.00.01.1.01.00\",\"placeholder\":null,\"seq\":1,\"type\":\"S\",\"valid_values\":null,\"value\":\"RU\"},{\"input\":\"input\",\"label\":\"value=Серия паспорта;display=L,F;grouped=true\",\"mode\":\"R\",\"name\":\"18.2003.00.01.1.02.00\",\"placeholder\":null,\"seq\":2,\"type\":\"S\",\"valid_values\":null,\"value\":\"45 10\"},{\"input\":\"input[required=true]\",\"label\":\"value=Номер паспорта;display=L,F;grouped=true\",\"mode\":\"R\",\"name\":\"18.2003.00.01.1.03.00\",\"placeholder\":null,\"seq\":3,\"type\":\"S\",\"valid_values\":null,\"value\":\"380897\"},{\"input\":\"input\",\"label\":\"value=Идентификационный номер (для не резидентов)\",\"mode\":\"R\",\"name\":\"18.2003.00.01.1.04.00\",\"placeholder\":null,\"seq\":4,\"type\":\"S\",\"valid_values\":null,\"value\":null},{\"input\":\"select[lookup=00.0000.00.00.0.00.03;required=true]\",\"label\":\"value=Пол;display=L,F\",\"mode\":\"R\",\"name\":\"18.2003.00.01.1.08.00\",\"placeholder\":null,\"seq\":8,\"type\":\"S\",\"valid_values\":[{\"display_name\":\"Мужской\",\"enabled_flag\":true,\"name\":\"M\"},{\"display_name\":\"Женский\",\"enabled_flag\":true,\"name\":\"F\"}],\"value\":\"F\"},{\"input\":\"date[required=true]\",\"label\":\"value=Дата рождения;display=L,F\",\"mode\":\"R\",\"name\":\"18.2003.00.01.1.09.00\",\"placeholder\":null,\"seq\":9,\"type\":\"I\",\"valid_values\":null,\"value\":\"593643599000\"},{\"input\":\"input[required=true;size=128]\",\"label\":\"value=Место рождения;display=L,F\",\"mode\":\"R\",\"name\":\"18.2003.00.01.1.10.00\",\"placeholder\":null,\"seq\":10,\"type\":\"S\",\"valid_values\":null,\"value\":\"ГОРОД МОСКВА\"},{\"input\":\"input[required=true;size=256]\",\"label\":\"value=Кем выдан;display=L,F\",\"mode\":\"R\",\"name\":\"18.2003.00.01.1.11.00\",\"placeholder\":null,\"seq\":11,\"type\":\"S\",\"valid_values\":null,\"value\":\"ОТДЕЛЕНИЕМ ПО РАЙОНУ ВЫХИНО ОУФМС РОССИИ ПО ГОР.МОСКВЕ\"},{\"input\":\"date[required=true]\",\"label\":\"value=Дата выдачи;display=L,F;grouped=true\",\"mode\":\"R\",\"name\":\"18.2003.00.01.1.12.00\",\"placeholder\":null,\"seq\":12,\"type\":\"I\",\"valid_values\":null,\"value\":\"1243886399000\"},{\"input\":\"input[size=64]\",\"label\":\"value=Код подразделения;display=L,F;grouped=true\",\"mode\":\"R\",\"name\":\"18.2003.00.01.1.13.00\",\"placeholder\":null,\"seq\":13,\"type\":\"S\",\"valid_values\":null,\"value\":\"770-100\"},{\"input\":\"input\",\"label\":\"value=Адрес регистрации(точно как в паспорте);display=L,F\",\"mode\":\"R\",\"name\":\"18.2003.00.01.1.14.00\",\"placeholder\":\"Укажите адрес регистрации точно как в паспорте\",\"seq\":14,\"type\":\"S\",\"valid_values\":null,\"value\":\"Московская обл., р-н Ленинский, д. Суханово, ЖК \\\"Суханово Парк\\\", дом 7, кв.20\"}],\"id\":40565459,\"item\":40565450,\"response_code\":null,\"response_mode\":\"W\",\"response_note\":null,\"tags\":null,\"version_id\":3},{\"class\":\"18.2003.00.02.0.00.00\",\"component\":null,\"description\":null,\"display_name\":\"value=\",\"fields\":[{\"input\":\"hint[name=S.00.0000.00.00.0.00.00.001;required=true;closable=true]\",\"label\":\"value=Адрес;display=L,F\",\"mode\":\"R\",\"name\":\"00.0000.00.00.2.16.00\",\"placeholder\":null,\"seq\":16,\"type\":\"S\",\"valid_values\":null,\"value\":\"Московская обл, г Видное, тер ЖК Суханово Парк (д Суханово), д 7, кв 20\"},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.02.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.02.00\",\"placeholder\":null,\"seq\":2,\"type\":\"S\",\"valid_values\":null,\"value\":\"Россия\"},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.03.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.03.00\",\"placeholder\":null,\"seq\":3,\"type\":\"S\",\"valid_values\":null,\"value\":\"Центральный\"},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.04.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.04.00\",\"placeholder\":null,\"seq\":4,\"type\":\"S\",\"valid_values\":null,\"value\":\"Московская\"},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.05.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.05.00\",\"placeholder\":null,\"seq\":5,\"type\":\"S\",\"valid_values\":null,\"value\":null},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.06.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.06.00\",\"placeholder\":null,\"seq\":6,\"type\":\"S\",\"valid_values\":null,\"value\":\"Видное\"},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.07.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.07.00\",\"placeholder\":null,\"seq\":7,\"type\":\"S\",\"valid_values\":null,\"value\":\"тер ЖК Суханово Парк (д Суханово)\"},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.08.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.08.00\",\"placeholder\":null,\"seq\":8,\"type\":\"S\",\"valid_values\":null,\"value\":null},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.09.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.09.00\",\"placeholder\":null,\"seq\":9,\"type\":\"S\",\"valid_values\":null,\"value\":\"7\"},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.10.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.10.00\",\"placeholder\":null,\"seq\":10,\"type\":\"S\",\"valid_values\":null,\"value\":null},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.11.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.11.00\",\"placeholder\":null,\"seq\":11,\"type\":\"S\",\"valid_values\":null,\"value\":\"20\"},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.12.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.12.00\",\"placeholder\":null,\"seq\":12,\"type\":\"S\",\"valid_values\":null,\"value\":null},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.13.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.13.00\",\"placeholder\":null,\"seq\":13,\"type\":\"S\",\"valid_values\":null,\"value\":\"50000025014003600000229\"},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.14.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.14.00\",\"placeholder\":null,\"seq\":14,\"type\":\"S\",\"valid_values\":null,\"value\":\"46407000226\"},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.15.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.15.00\",\"placeholder\":null,\"seq\":15,\"type\":\"S\",\"valid_values\":null,\"value\":\"46707000326\"},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.17.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.17.00\",\"placeholder\":null,\"seq\":17,\"type\":\"S\",\"valid_values\":null,\"value\":\"Московская обл., р-н Ленинский, д. Суханово, ЖК \\\"Суханово Парк\\\", дом 7, кв.20\"},{\"input\":\"input\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.18.00\",\"placeholder\":null,\"seq\":18,\"type\":\"S\",\"valid_values\":null,\"value\":\"UTC+3\"},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.01.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.01.00\",\"placeholder\":null,\"seq\":1,\"type\":\"S\",\"valid_values\":null,\"value\":\"142702\"},{\"input\":\"input[hint=S.00.0000.00.00.0.00.00.001;hfield=S.00.0000.00.00.0.19.00.001]\",\"label\":null,\"mode\":\"R\",\"name\":\"00.0000.00.00.2.19.00\",\"placeholder\":null,\"seq\":19,\"type\":\"S\",\"valid_values\":null,\"value\":\"{\\\"area\\\":null,\\\"area_fias_id\\\":null,\\\"area_kladr_id\\\":null,\\\"area_type\\\":null,\\\"area_type_full\\\":null,\\\"area_with_type\\\":null,\\\"beltway_distance\\\":6,\\\"beltway_hit\\\":\\\"OUT_MKAD\\\",\\\"block\\\":null,\\\"block_type\\\":null,\\\"block_type_full\\\":null,\\\"capital_marker\\\":1,\\\"city\\\":\\\"Видное\\\",\\\"city_area\\\":null,\\\"city_district_fias_id\\\":null,\\\"city_district_kladr_id\\\":null,\\\"city_district_type\\\":null,\\\"city_district_type_full\\\":null,\\\"city_district_with_type\\\":null,\\\"city_fias_id\\\":\\\"9a72b510-9413-41d8-b076-576fbfd78404\\\",\\\"city_kladr_id\\\":\\\"5000002500000\\\",\\\"city_type\\\":\\\"г\\\",\\\"city_type_full\\\":\\\"город\\\",\\\"city_with_type\\\":\\\"г Видное\\\",\\\"coordinates_quality\\\":null,\\\"country\\\":\\\"Россия\\\",\\\"delivery_quality\\\":\\\"NOT_AVAILABLE\\\",\\\"federal_district\\\":\\\"Центральный\\\",\\\"fias_actuality_state\\\":0,\\\"fias_code\\\":\\\"50000025014003600000229\\\",\\\"fias_id\\\":\\\"17f014ac-e777-48bc-ac59-4414778c455d\\\",\\\"fias_level\\\":9,\\\"flat\\\":\\\"20\\\",\\\"flat_area\\\":null,\\\"flat_price\\\":null,\\\"flat_type\\\":\\\"кв\\\",\\\"flat_type_full\\\":\\\"квартира\\\",\\\"house\\\":\\\"7\\\",\\\"house_fias_id\\\":\\\"56c758c9-b295-40f1-8423-668f958ec00c\\\",\\\"house_kladr_id\\\":\\\"5000002501400360229\\\",\\\"house_type\\\":\\\"д\\\",\\\"house_type_full\\\":\\\"дом\\\",\\\"kladr_id\\\":\\\"5000002501400360229\\\",\\\"latitude\\\":55.52436,\\\"longitude\\\":37.643806,\\\"metro\\\":[{\\\"distance\\\":5,\\\"line\\\":\\\"Курско-Рижский\\\",\\\"name\\\":\\\"Бутово\\\"}],\\\"okato\\\":\\\"46407000226\\\",\\\"oktmo\\\":\\\"46707000326\\\",\\\"post_quality\\\":null,\\\"postal_box\\\":null,\\\"postal_code\\\":\\\"142702\\\",\\\"quality\\\":null,\\\"region\\\":\\\"Московская\\\",\\\"region_fias_id\\\":\\\"29251dcf-00a1-4e34-98d4-5c47484a36d4\\\",\\\"region_kladr_id\\\":\\\"5000000000000\\\",\\\"region_type\\\":\\\"обл\\\",\\\"region_type_full\\\":\\\"область\\\",\\\"region_with_type\\\":\\\"Московская обл\\\",\\\"result\\\":\\\"Московская обл, г Видное, тер ЖК Суханово Парк (д Суханово), д 7, кв 20\\\",\\\"settlement\\\":\\\"ЖК Суханово Парк (д Суханово)\\\",\\\"settlement_fias_id\\\":\\\"0e5e6dcc-5adf-4195-8a04-ca90d1aaf9a2\\\",\\\"settlement_kladr_id\\\":\\\"50000025014003600\\\",\\\"settlement_type\\\":\\\"тер\\\",\\\"settlement_type_full\\\":\\\"территория\\\",\\\"settlement_with_type\\\":\\\"тер ЖК Суханово Парк (д Суханово)\\\",\\\"source\\\":\\\"Московская обл., р-н Ленинский, д. Суханово, ЖК \\\\\\\"Суханово Парк\\\\\\\", дом 7, кв.20\\\",\\\"square_meter_price\\\":null,\\\"street\\\":null,\\\"street_fias_id\\\":null,\\\"street_kladr_id\\\":null,\\\"street_type\\\":null,\\\"street_type_full\\\":null,\\\"street_with_type\\\":null,\\\"tax_office\\\":\\\"5003\\\",\\\"tax_office_legal\\\":\\\"5003\\\",\\\"timezone\\\":\\\"UTC+3\\\",\\\"unparsed_parts\\\":null}\"}],\"id\":40565461,\"item\":40565450,\"response_code\":null,\"response_mode\":\"W\",\"response_note\":null,\"tags\":null,\"version_id\":8}],\"response_code\":\"D\",\"response_mode\":\"W\",\"response_note\":\"Подпишите\",\"state\":\"U\",\"state_at\":1676630149630,\"tags\":null,\"unit\":{\"id\":40300007,\"name\":\"274745\",\"path\":\"/1/1113/40300007/\"},\"updated_at\":1676630337936,\"version_id\":4}")]
        [InlineData("{\"value\":\"Московская обл., р-н Ленинский, д. Суханово, ЖК \\\\\"Суханово Парк\\\\ тут что-то еще\",\"actions\":12345}")]
        [InlineData("{\"value\":\"Московская обл., р-н Ленинский, д. Суханово, ЖК \\\\\"Суханово Парк\\\\\" а теперь еще и здесь\",\"actions\":null}")]
        [InlineData("{\"value\":\"Московская обл., р-н Ленинский, д. Суханово, ЖК \\\\\\\"Суханово Парк\\\\\\\" очень много слэшей\",\"actions\":null}")]
        [InlineData("{\"value\":\"Московская обл., р-н Ленинский, д. Суханово, ЖК \\\\\\\\\"Суханово Парк\\\\\\\" очень много невыровненных слэшей\",\"actions\":null}")]
        [InlineData("{\"walue\":\"Московская обл., р-н Ленинский, д. Суханово, ЖК \\\"Суханово Парк\\\" дом 111\",\"actions\":null}")]
        [InlineData("{\"walue\":\"Московская обл., р-н Ленинский, д. Суханово, ЖК \\\"Суханово Парк\\\"\",\"actions\":null}")]
        [Theory]
        public void QuoteEscapingTest_ShouldNotTruncate(string source)
        {
            var resolver = CompositeResolver.Create(new IJsonFormatter[] { new RawJsonWrapperFormatter() }, new[] { StandardResolver.SnakeCase });
            
			var wrapper = JsonSerializer.Deserialize<RawJsonWrapper>(source, resolver);
			var res = Encoding.UTF8.GetString(wrapper);
			
			Assert.Equal(source, res);
        }
        
        [InlineData("{\"value\": \"string \\\"inner\\\"\"}", "string \"inner\"")]
        [InlineData("{\"value\": \"string \\\\\\\"inner\\\"\"}", "string \\\\\"inner\"")]
        [Theory]
        public void ShouldDeserializeProps(string source, string expected)
        {
            var resolver = CompositeResolver.Create(Array.Empty<IJsonFormatter>(), new[] { StandardResolver.SnakeCase });
            var map = JsonSerializer.Deserialize<Dictionary<string, object>>(source, resolver);
            
            Assert.Equal(expected, map["value"]);
        }

        [InlineData("{\"value\": \"Б\\Н\"}", "Б\\Н")]
        [InlineData("{\"value\": \"A\\Because there is so much text in here\"}", "A\\Because there is so much text in here")]
        [InlineData("{\"value\": \"A\\Because there \\is so much \\characters here\"}", "A\\Because there \\is so much \\characters here")]
        [Theory]
        public void ShouldHandleDoubleSlash_WhenDeserializedToDictionary(string json, string expected)
        {
            var resolver =
                CompositeResolver.Create(Array.Empty<IJsonFormatter>(), new[] { StandardResolver.SnakeCase });
            
            var result = JsonSerializer.Deserialize<Dictionary<string, object?>>(json, resolver);
            Assert.Equal(expected, result["value"]);
        }
        
        [InlineData("{\"value\": \"Б\\Н\"}")]
        [InlineData("{\"value\": \"A\\Because there is so much text in here\"}")]
        [InlineData("{\"value\": \"A\\Because there \\is so much \\characters here\"}")]
        [Theory]
        public void ShouldHandleDoubleSlash_WhenDeserializedToWrapper(string json)
        {
            var resolver = CompositeResolver.Create(new IJsonFormatter[] { new RawJsonWrapperFormatter() },
                new[] { StandardResolver.SnakeCase });
            
            var result = JsonSerializer.Deserialize<RawJsonWrapper>(json, resolver);
            
            var res = Encoding.UTF8.GetString(result);

            Assert.Equal(json, res);
        }
    }
}